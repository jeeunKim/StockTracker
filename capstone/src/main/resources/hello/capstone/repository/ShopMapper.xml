<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hello.capstone.repository.ShopMapper">
    

	<select id="findByAddress" resultType ="Shop">
		select * from shop where shopaddress = #{address} Limit 1;
	</select>
	
	<insert id="saveShop">
      insert into shop(shopname, shopaddress, owneridx	,shoptel, shopwebsite, imagefilename, promotionText, registrationDate, longitude, latitude) values( #{shopName}, #{shopAddress}, #{ownerIdx},#{shopTel}, #{shopWebsite}, #{imageFilename}, #{promotionText}, #{registrationDate}, #{longitude}, #{latitude});
	</insert>
	
	<select id="getShopIdx">
		select shopidx from shop where shopname = #{shopName} and shopaddress = #{shopAddress};
	</select>
	
	<select id="getShopByIdx">
		select * from shop where shopidx = #{shopidx};
	</select>
	
	<select id="getShopByItemIdx" resultType = "Shop">
		select s.* 
		from shop s
		join item i on i.shopidx = s.shopidx
		where i.itemidx = #{itemidx};
	</select>
	
	<select id = "getShops" resultType = "Shop">
		select distinct s.*
		from shop s
		inner join item i ON s.shopidx = i.shopidx
		where i.endtime &gt;= now();
	</select>
	
	<select id = "getShopByMember" resultType = "hashmap">
		select * 
		from shop
		where owneridx = #{memberidx};
	</select>
	
	<update id="modifyShop">
		update shop set shopname = #{shopName}, shopaddress = #{shopAddress}, owneridx = #{ownerIdx}, shoptel = #{shopTel}, shopwebsite = #{shopWebsite}, imagefilename = #{imageFilename}, promotionText = #{promotionText}, longitude = #{longitude}, latitude = #{latitude}
		where shopidx = #{shopidx}
		 
	</update>
	
	<select id = "runPriceFilter" resultType = "Shop">
		select * 
		from shop 
		where shopidx in (
			select distinct shopidx from item where salecost &lt;= #{price} and endtime &lt;= #{now()}
		);
	</select>
	
	<select id = "runRatingFilter" resultType = "Shop">
		select * from shop where #{rating} &lt;= rating
	</select>
	
	<update id = "setRatings">
		update shop set rating = #{rating}
		where shopidx = #{shopidx};
	</update>
</mapper>